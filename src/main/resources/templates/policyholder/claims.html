<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/dashboard}">
<head>
    <title>My Claims - MediSure</title>
</head>
<body>

<!-- Page Header -->
<div layout:fragment="page-header" class="mb-8">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-slate-900 mb-2">My Claims</h1>
            <p class="text-slate-600">Track and manage your insurance claims</p>
        </div>
        <a href="/policyholder/claims/new" 
           class="inline-flex items-center gap-2 px-4 py-2 bg-primary-600 border border-transparent rounded-lg text-sm font-medium text-white hover:bg-primary-700">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
            File New Claim
        </a>
    </div>
</div>

<!-- Main Content -->
<div layout:fragment="content">
    
    <!-- Loading State -->
    <div id="loadingState" class="bg-white rounded-xl shadow-sm border border-slate-200 p-12">
        <div class="text-center">
            <svg class="animate-spin h-12 w-12 text-primary-600 mx-auto mb-4" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-slate-600">Loading your claims...</p>
        </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="bg-white rounded-xl shadow-sm border border-slate-200 p-12" style="display: none;">
        <div class="text-center max-w-md mx-auto">
            <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-slate-900 mb-3">No Claims Filed</h2>
            <p class="text-slate-600 mb-6">
                You haven't filed any claims yet. When you need to claim medical expenses, you can file them here.
            </p>
            <a href="/policyholder/claims/new" 
               class="inline-flex items-center gap-2 px-6 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition font-medium">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                File Your First Claim
            </a>
        </div>
    </div>

    <!-- Claims List -->
    <div id="claimsList" style="display: none;">
        
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm font-medium text-slate-600">Total Claims</p>
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                </div>
                <p id="totalClaims" class="text-2xl font-bold text-slate-900">0</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm font-medium text-slate-600">Pending</p>
                    <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
                <p id="pendingClaims" class="text-2xl font-bold text-slate-900">0</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm font-medium text-slate-600">Approved</p>
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
                <p id="approvedClaims" class="text-2xl font-bold text-slate-900">0</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm font-medium text-slate-600">Total Amount</p>
                    <div class="w-10 h-10 bg-primary-100 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
                <p id="totalAmount" class="text-2xl font-bold text-slate-900">$0</p>
            </div>
        </div>

        <!-- Claims Table -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Claim ID</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Description</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Amount</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="claimsTableBody" class="divide-y divide-slate-200">
                        <!-- Claims will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
</div>

<!-- Custom JavaScript -->
<script layout:fragment="scripts">
    let claims = [];

    // Format date
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    // Get status badge HTML
    function getStatusBadge(status) {
        const statusConfig = {
            'SUBMITTED': { color: 'blue', label: 'Submitted' },
            'UNDER_REVIEW': { color: 'yellow', label: 'Under Review' },
            'APPROVED_BY_CLAIMS': { color: 'green', label: 'Approved by Claims' },
            'FORWARDED_TO_FINANCE': { color: 'indigo', label: 'Forwarded to Finance' },
            'APPROVED_BY_FINANCE': { color: 'green', label: 'Approved' },
            'REJECTED': { color: 'red', label: 'Rejected' },
            'REQUIRES_CORRECTION': { color: 'orange', label: 'Needs Correction' }
        };
        
        const config = statusConfig[status] || { color: 'gray', label: status };
        const colors = {
            blue: 'bg-blue-100 text-blue-800',
            yellow: 'bg-yellow-100 text-yellow-800',
            green: 'bg-green-100 text-green-800',
            red: 'bg-red-100 text-red-800',
            orange: 'bg-orange-100 text-orange-800',
            indigo: 'bg-indigo-100 text-indigo-800',
            gray: 'bg-gray-100 text-gray-800'
        };
        
        return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colors[config.color]}">${config.label}</span>`;
    }

    // Load claims
    async function loadClaims() {
        try {
            const response = await fetch('/api/claims/my-claims', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    claims = data.data || [];
                    displayClaims();
                }
            }
        } catch (error) {
            console.error('Error loading claims:', error);
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }
    }

    // Display claims
    function displayClaims() {
        document.getElementById('loadingState').style.display = 'none';
        
        if (claims.length === 0) {
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('claimsList').style.display = 'none';
        } else {
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('claimsList').style.display = 'block';
            
            // Update stats
            const totalClaims = claims.length;
            const pendingClaims = claims.filter(c => c.status === 'SUBMITTED' || c.status === 'UNDER_REVIEW' || c.status === 'FORWARDED_TO_FINANCE').length;
            const approvedClaims = claims.filter(c => c.status === 'APPROVED_BY_FINANCE').length;
            const totalAmount = claims.reduce((sum, c) => sum + parseFloat(c.amountClaimed || 0), 0);
            
            document.getElementById('totalClaims').textContent = totalClaims;
            document.getElementById('pendingClaims').textContent = pendingClaims;
            document.getElementById('approvedClaims').textContent = approvedClaims;
            document.getElementById('totalAmount').textContent = '$' + totalAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            // Populate table
            const tbody = document.getElementById('claimsTableBody');
            tbody.innerHTML = claims.map(claim => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm font-medium text-slate-900">#${claim.id}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm text-slate-600">${formatDate(claim.claimDate)}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-slate-900 max-w-xs truncate">${claim.description}</div>
                        ${claim.hospitalName ? `<div class="text-xs text-slate-500 mt-1">${claim.hospitalName}</div>` : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm font-medium text-slate-900">$${parseFloat(claim.amountClaimed).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${getStatusBadge(claim.status)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="viewClaim(${claim.id})" class="text-primary-600 hover:text-primary-800 font-medium">
                            View Details
                        </button>
                    </td>
                </tr>
            `).join('');
        }
    }

    // View claim details (placeholder)
    function viewClaim(claimId) {
        const claim = claims.find(c => c.id === claimId);
        if (claim) {
            alert(`Claim #${claimId}\n\nDescription: ${claim.description}\nAmount: $${claim.amountClaimed}\nStatus: ${claim.status}\n\n${claim.remarks ? 'Remarks: ' + claim.remarks : ''}`);
        }
    }

    // Load claims on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadClaims();
    });
</script>

</body>
</html>

